<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤ - Firebase Real-time</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .charging-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-charging { background-color: #F59E0B; animation: pulse 2s infinite; }
        .status-completed { background-color: #3B82F6; }
        .live-indicator {
            animation: pulse-live 2s infinite;
        }
        @keyframes pulse-live {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Overlay -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-md">
            <h2 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-2">üîê ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡∏ô</h2>
            <p class="text-center text-gray-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            <div class="space-y-4">
                <div>
                    <label for="login-user" class="block text-sm font-semibold text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                    <select id="login-user" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...</option>
                    </select>
                </div>
                <div id="login-vehicle-wrapper">
                    <label for="login-vehicle" class="block text-sm font-semibold text-gray-700 mb-2">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
                    <select id="login-vehicle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div id="login-charger-wrapper">
                    <label for="login-charger" class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</label>
                    <select id="login-charger" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                    <input type="password" id="login-password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
                </div>
                <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 shadow-lg">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden by default) -->
    <div class="container mx-auto px-2 sm:px-4 max-w-7xl py-8 hidden">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-2">‚ö° ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü‡∏£‡∏ñ‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h1>
            <p class="text-gray-600">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏±‡∏ô (Real-time)</p>
            <!-- Navigation Menu -->
            <div class="flex justify-center mt-6">
                <div class="bg-white rounded-lg shadow-lg p-2 flex space-x-1 sm:space-x-2">
                    <button onclick="window.showSection('charging')" id="btn-charging"
                            class="px-4 sm:px-6 py-2 rounded-lg font-medium transition duration-200 bg-blue-600 text-white text-sm sm:text-base">
                        üîã ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
                    </button>
                    <button onclick="window.showSection('summary')" id="btn-summary"
                            class="px-4 sm:px-6 py-2 rounded-lg font-medium transition duration-200 text-gray-600 hover:bg-gray-100 text-sm sm:text-base">
                        üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à
                    </button>
                </div>
            </div>
        </div>

        <!-- Charging Section -->
        <div id="chargingSection">
            <!-- New Charging Form -->
            <div id="new-charging-wrapper" class="bg-white rounded-2xl shadow-xl mb-8">
                <div class="p-4 sm:p-6 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">‚ûï ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÉ‡∏´‡∏°‡πà</h2>
                        <button onclick="window.toggleNewChargingForm()" id="toggleFormBtn"
                                class="bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 sm:px-4 py-2 rounded-lg transition duration-200 font-medium text-sm">
                            <span id="toggleFormText">‡∏ã‡πà‡∏≠‡∏ô</span> üìù
                        </button>
                    </div>
                </div>
                <div id="newChargingFormContainer" class="p-4 sm:p-8">
                    <form id="newChargingForm" class="space-y-6">
                        <!-- Row 1: Date, License Plate, and Charger -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" id="date" name="date" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ</label>
                                <input type="hidden" id="licensePlate" name="licensePlate" required>
                                <div class="grid grid-cols-2 gap-3" id="licensePlateButtons">
                                    <!-- License plate buttons will be populated here -->
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</label>
                                <input type="hidden" id="chargerName" name="chargerName" required>
                                <div class="grid grid-cols-2 gap-3" id="chargerButtons">
                                    <!-- Charger buttons will be populated here -->
                                </div>
                            </div>
                        </div>

                        <!-- Row 2: Mileage -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô</label>
                                <input type="number" id="previousMileage" name="previousMileage" step="0.1" required readonly
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ‡∏Å‡πà‡∏≠‡∏ô">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</label>
                                <input type="number" id="currentMileage" name="currentMileage" step="0.1" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            </div>
                        </div>

                        <!-- Row 3: KWH Before and Price Info -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏≤‡∏£‡πå‡∏à (%)</label>
                                <input type="number" id="kwhBefore" name="kwhBefore" step="1" min="0" max="100" required
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="‡πÄ‡∏ä‡πà‡∏ô 20">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢ (‡∏ö‡∏≤‡∏ó)</label>
                                <div class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-700 font-medium" id="pricePerUnitDisplay">
                                    ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à
                                </div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <div>üî¥ ‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ: 12:00-13:00, 17:00-17:30 (4.1839 ‡∏ö‡∏≤‡∏ó)</div>
                                    <div>üü¢ ‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏ü‡∏û‡∏µ‡∏Ñ: 00:00-01:00, 05:00-05:30 (2.6037 ‡∏ö‡∏≤‡∏ó)</div>
                                    <div>üü° ‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ (3.5000 ‡∏ö‡∏≤‡∏ó)</div>
                                </div>
                            </div>
                        </div>

                        <!-- Row 4: Start Button -->
                        <div class="flex justify-center">
                            <button type="button" id="startNewChargingBtn"
                                    class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-lg hover:shadow-xl">
                                üîã ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Active Charging Sessions -->
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <div class="flex items-center space-x-3">
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üîã ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
                        <div id="liveStatus" class="flex items-center text-xs font-medium px-2 py-1 rounded-full bg-green-100 text-green-700">
                            <div class="w-2 h-2 rounded-full bg-green-500 mr-2 live-indicator"></div>
                            <span>LIVE</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4 text-xs sm:text-sm">
                        <span class="status-indicator status-charging"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à
                        <span class="status-indicator status-completed ml-4"></span>‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                    </div>
                </div>
                <div id="activeChargingSessions" class="space-y-4"></div>
            </div>

            <!-- Vehicle Status Overview -->
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">üöó ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏ñ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 sm:gap-4" id="vehicleStatusGrid"></div>
            </div>

            <!-- Charger Status Overview -->
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">üîå ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2 sm:gap-4" id="chargerStatusGrid"></div>
            </div>

            <!-- Charging History -->
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8 mb-8">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üìà ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                    <div class="flex space-x-2 w-full sm:w-auto">
                        <select id="historyVehicleFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>
                        </select>
                        <select id="historyMonthFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>
                </div>
                <div id="chargingHistoryContainer" class="overflow-x-auto"></div>
            </div>
        </div> <!-- End Charging Section -->

        <!-- Summary Section -->
        <div id="summarySection" class="hidden">
            <!-- Summary Filters -->
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</h2>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 w-full md:w-auto">
                        <select id="summaryVehicleFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>
                        </select>
                        <select id="summaryMonthFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl shadow-xl p-6 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-blue-100 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p><p class="text-3xl font-bold" id="totalSessions">0</p></div><div class="text-4xl opacity-80">üîã</div></div>
                </div>
                <div class="bg-gradient-to-r from-green-500 to-green-600 rounded-2xl shadow-xl p-6 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-green-100 text-sm">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</p><p class="text-3xl font-bold" id="totalCost">‡∏ø0</p></div><div class="text-4xl opacity-80">üí∞</div></div>
                </div>
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 rounded-2xl shadow-xl p-6 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-purple-100 text-sm">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</p><p class="text-3xl font-bold" id="totalUnits">0</p></div><div class="text-4xl opacity-80">‚ö°</div></div>
                </div>
                <div class="bg-gradient-to-r from-orange-500 to-orange-600 rounded-2xl shadow-xl p-6 text-white">
                    <div class="flex items-center justify-between"><div><p class="text-orange-100 text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</p><p class="text-3xl font-bold" id="totalTime">0</p></div><div class="text-4xl opacity-80">‚è±Ô∏è</div></div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6"><h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">üí∞ ‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô</h3><div class="h-80"><canvas id="costChart"></canvas></div></div>
                <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6"><h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">üîã ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô</h3><div class="h-80"><canvas id="sessionsChart"></canvas></div></div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">üîå ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</h3>
                <div class="h-80"><canvas id="chargerUsageChart"></canvas></div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                <div class="h-96"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8 mb-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-6">üöó ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏±‡∏ô</h3>
                <div id="vehicleStatsContainer"></div>
            </div>
            <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8">
                <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-6">üîå ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</h3>
                <div id="chargerStatsContainer"></div>
            </div>
        </div>
    </div>
    
    <div id="auth-status" class="fixed bottom-4 right-4 bg-white shadow-lg rounded-lg px-4 py-2 text-xs text-gray-600">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, collection, query, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        const vehicles = ['TT-19', 'TT-20', 'TT-21', 'TT-22', 'TT-23', 'TT-24 Spare part']; 
        const chargers = ['EV-C1', 'EV-C2', 'EV-C3', 'EV-C4', 'EV-C5'];
        
        // --- GLOBAL STATE ---
        let db, auth;
        let firebaseUserId = null;
        let appId = 'sodium-burner-428202-f9'; 
        let currentUser = null; 
        let allUsers = {};

        let vehicleStatuses = {};
        let chargerStatuses = {};
        let allHistoryRecords = []; 
        let summaryCharts = {};

        // Register Chart.js plugins
        Chart.register(ChartDataLabels);

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyCEN8ANVFzs2dExfJP-HDTuRGxtV3TYzHU",
                  authDomain: "sodium-burner-428202-f9.firebaseapp.com",
                  projectId: "sodium-burner-428202-f9",
                  storageBucket: "sodium-burner-428202-f9.appspot.com",
                  messagingSenderId: "46765828618",
                  appId: "1:46765828618:web:59eb170cfcd92c0e578df3",
                  measurementId: "G-MJ19J3TF2R"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                Swal.fire('Error', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                return;
            }

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    firebaseUserId = user.uid;
                    console.log("Firebase user authenticated:", firebaseUserId);
                    document.getElementById('auth-status').innerHTML = `üü¢ Connected`;
                    
                    await initializeSystemState();
                    await seedInitialUsers(); 
                    await setupLoginScreen();

                } else {
                    console.log("User is not signed in. Attempting to sign in anonymously.");
                    document.getElementById('auth-status').textContent = 'üü° Authenticating...';
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Anonymous authentication failed:", error);
                        document.getElementById('auth-status').textContent = 'üî¥ Auth Failed';
                    }
                }
            });
        });

        // --- LOGIN SYSTEM ---
        async function setupLoginScreen() {
            const usersColRef = collection(db, `artifacts/${appId}/users`);
            const userSnapshot = await getDocs(usersColRef);
            const userSelect = document.getElementById('login-user');
            const vehicleSelect = document.getElementById('login-vehicle');
            const chargerSelect = document.getElementById('login-charger');
            const vehicleWrapper = document.getElementById('login-vehicle-wrapper');
            const chargerWrapper = document.getElementById('login-charger-wrapper');

            allUsers = {};
            userSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ --</option>';
            userSnapshot.forEach(doc => {
                allUsers[doc.id] = doc.data();
                userSelect.innerHTML += `<option value="${doc.id}">${doc.data().name}</option>`;
            });

            vehicleSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ --</option>';
            vehicles.forEach(v => vehicleSelect.innerHTML += `<option value="${v}">${v}</option>`);

            chargerSelect.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à --</option>';
            chargers.forEach(c => chargerSelect.innerHTML += `<option value="${c}">${c}</option>`);
            
            userSelect.addEventListener('change', () => {
                const selectedUserId = userSelect.value;
                const selectedUser = allUsers[selectedUserId];
                if (selectedUser && selectedUser.role === 'supervisor') {
                    vehicleWrapper.style.display = 'none';
                    chargerWrapper.style.display = 'none';
                } else {
                    vehicleWrapper.style.display = 'block';
                    chargerWrapper.style.display = 'block';
                }
            });

            document.getElementById('login-btn').addEventListener('click', handleLogin);
        }

        async function handleLogin() {
            const loginButton = document.getElementById('login-btn');
            loginButton.disabled = true;
            loginButton.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

            const userId = document.getElementById('login-user').value;
            const vehicle = document.getElementById('login-vehicle').value;
            const charger = document.getElementById('login-charger').value;
            const password = document.getElementById('login-password').value;
            const selectedUser = allUsers[userId];

            if (!userId || !password) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', 'warning');
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                return;
            }

            try {
                if (!selectedUser) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö');
                }

                if (selectedUser.password !== password) {
                    throw new Error('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                }

                const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
                const stateDocSnap = await getDoc(stateDocRef);
                
                if (!stateDocSnap.exists()) {
                     throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•');
                }

                const stateData = stateDocSnap.data();
                vehicleStatuses = stateData.vehicleStatuses || {};
                chargerStatuses = stateData.chargerStatuses || {};

                currentUser = {
                    name: selectedUser.name,
                    role: selectedUser.role || 'employee'
                };

                if (currentUser.role === 'employee') {
                    if (!vehicle || !charger) {
                        throw new Error('‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à');
                    }
                    
                    const vehicleStatus = vehicleStatuses[vehicle];
                    const chargerStatus = chargerStatuses[charger];

                    if (vehicleStatus?.status === 'out-of-service') {
                        throw new Error(`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ ${vehicle} ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢)`);
                    }
                     if (chargerStatus?.status === 'out-of-service') {
                        throw new Error(`‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à ${charger} ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢)`);
                    }

                    if (vehicleStatus && vehicleStatus.status !== 'available') {
                        const activeSessionRef = doc(db, `artifacts/${appId}/active_sessions`, vehicleStatus.sessionId);
                        const activeSessionSnap = await getDoc(activeSessionRef);
                        if (!activeSessionSnap.exists() || activeSessionSnap.data().startedBy !== currentUser.name) {
                            throw new Error(`‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏£‡∏ñ ${vehicle} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô`);
                        }
                    }
                    
                    if (chargerStatus && chargerStatus.status !== 'available') {
                         const activeSessionRef = doc(db, `artifacts/${appId}/active_sessions`, chargerStatus.sessionId);
                        const activeSessionSnap = await getDoc(activeSessionRef);
                         if (!activeSessionSnap.exists() || activeSessionSnap.data().startedBy !== currentUser.name) {
                            throw new Error(`‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à ${charger} ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏∑‡πà‡∏ô`);
                        }
                    }
                    currentUser.vehicle = vehicle;
                    currentUser.charger = charger;
                }
                
                document.getElementById('login-overlay').classList.add('hidden');
                document.querySelector('.container').classList.remove('hidden');
                
                setupRealtimeListeners();
                initializeUI();

                if (currentUser.role === 'employee') {
                    prepopulateForm(currentUser.vehicle, currentUser.charger);
                } else {
                    document.getElementById('new-charging-wrapper').style.display = 'none';
                }

            } catch (error) {
                Swal.fire('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', error.message, 'error');
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
            }
        }

        function prepopulateForm(vehicle, charger) {
            window.selectLicensePlate(vehicle);
            window.selectCharger(charger);

            document.querySelectorAll('#licensePlateButtons button, #chargerButtons button').forEach(btn => {
                btn.disabled = true;
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.onclick = null;
            });
        }

        async function seedInitialUsers() {
            const usersColRef = collection(db, `artifacts/${appId}/users`);
            const snapshot = await getDocs(usersColRef);
            
            const existingUsers = new Set();
            snapshot.forEach(doc => {
                existingUsers.add(doc.data().name);
            });

            const sampleUsers = [
                { name: "‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô", password: "super", role: "supervisor" },
                { name: "‡∏ô‡∏≤‡∏¢‡∏Å‡∏§‡∏©‡∏é‡∏≤ ‡πÄ‡∏Å‡∏¥‡∏î‡πÄ‡∏™‡∏°", password: "55053156", role: "supervisor" },
                { name: "‡∏ô‡∏≤‡∏á‡∏û‡∏∏‡∏™‡∏î‡∏µ ‡∏®‡∏£‡∏µ‡∏ß‡∏±‡∏í‡∏ô‡∏≤", password: "48070418", role: "supervisor" },
                { name: "‡∏ô‡∏≤‡∏¢‡∏ú‡πà‡∏≠‡∏á ‡∏Ñ‡∏•‡∏≠‡∏ô‡πÇ‡∏û‡∏ò‡∏¥‡πå", password: "1234", role: "supervisor" },
                { name: "‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡∏®‡∏¥‡∏£‡∏¥‡∏ô‡∏†‡∏≤ ‡∏à‡∏¥‡∏ì‡∏®‡∏¥‡∏£‡∏¥", password: "64060030", role: "supervisor" }
            ];

            const newUsers = sampleUsers.filter(user => !existingUsers.has(user.name));

            if (newUsers.length > 0) {
                console.log(`Found ${newUsers.length} new users to seed...`);
                const batch = writeBatch(db);
                newUsers.forEach(user => {
                    const newUserRef = doc(usersColRef);
                    batch.set(newUserRef, user);
                });
                await batch.commit();
                console.log("New users seeded.");
            } else {
                console.log("No new users to seed.");
            }
        }


        function initializeUI() {
            createLicensePlateButtons();
            createChargerButtons();
            setTodayDate();
            initializeHistoryFilters();
            initializeSummaryFilters();
            
            document.getElementById('historyVehicleFilter').addEventListener('change', () => displayChargingHistory(allHistoryRecords));
            document.getElementById('historyMonthFilter').addEventListener('change', () => displayChargingHistory(allHistoryRecords));
            document.getElementById('summaryVehicleFilter').addEventListener('change', loadSummaryData);
            document.getElementById('summaryMonthFilter').addEventListener('change', loadSummaryData);
            
            updatePricePerUnitDisplay();
            setInterval(updatePricePerUnitDisplay, 60000);
        }

        function setupRealtimeListeners() {
            if (!db || !firebaseUserId) return;

            const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
            const activeSessionsColRef = collection(db, `artifacts/${appId}/active_sessions`);
            const historyColRef = collection(db, `artifacts/${appId}/history`);

            onSnapshot(stateDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    vehicleStatuses = data.vehicleStatuses || {};
                    chargerStatuses = data.chargerStatuses || {};
                } 
                updateVehicleStatusGrid();
                updateChargerStatusGrid();
            });

            onSnapshot(query(activeSessionsColRef), (snapshot) => {
                const activeSessions = {};
                snapshot.forEach(doc => {
                    activeSessions[doc.id] = { ...doc.data(), sessionId: doc.id };
                });
                updateActiveChargingSessions(activeSessions);
            });

            onSnapshot(query(historyColRef), (snapshot) => {
                allHistoryRecords = [];
                snapshot.forEach(doc => {
                    allHistoryRecords.push({ ...doc.data(), id: doc.id });
                });
                allHistoryRecords.sort((a, b) => new Date(b.date) - new Date(a.date));
                displayChargingHistory(allHistoryRecords);
                loadSummaryData();
            });
        }

        async function initializeSystemState() {
            const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
            const docSnap = await getDoc(stateDocRef);
            let needsUpdate = false;
            let currentVehicleStatuses = {};
            let currentChargerStatuses = {};

            if (docSnap.exists()) {
                const data = docSnap.data();
                currentVehicleStatuses = data.vehicleStatuses || {};
                currentChargerStatuses = data.chargerStatuses || {};
            } else {
                needsUpdate = true;
            }

            vehicles.forEach(v => {
                if (!currentVehicleStatuses[v]) {
                    currentVehicleStatuses[v] = { status: 'available', lastMileage: 0, sessionId: null };
                    needsUpdate = true;
                    console.log(`Adding new vehicle '${v}' to state.`);
                }
            });

            chargers.forEach(c => {
                if (!currentChargerStatuses[c]) {
                    currentChargerStatuses[c] = { status: 'available', totalUsage: 0, sessionId: null };
                    needsUpdate = true;
                    console.log(`Adding new charger '${c}' to state.`);
                }
            });

            if (needsUpdate) {
                try {
                    await setDoc(stateDocRef, {
                        vehicleStatuses: currentVehicleStatuses,
                        chargerStatuses: currentChargerStatuses,
                        lastUpdated: new Date().toISOString()
                    }, { merge: true });
                    console.log("System state initialized/updated successfully.");
                } catch (error) {
                    console.error("Error initializing/updating system state:", error);
                }
            } else {
                console.log("System state is up to date.");
            }
        }

        function updateVehicleStatusGrid() {
            const grid = document.getElementById('vehicleStatusGrid');
            grid.innerHTML = '';
            vehicles.forEach(vehicle => {
                const status = vehicleStatuses[vehicle] || { status: 'available', lastMileage: 0 };
                const card = document.createElement('div');
                let statusColor = '', statusText = '', statusIcon = '';
                switch(status.status) {
                    case 'available': statusColor = 'border-green-200 bg-green-50'; statusText = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusIcon = '‚úÖ'; break;
                    case 'charging': statusColor = 'border-yellow-200 bg-yellow-50'; statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à'; statusIcon = 'üîã'; break;
                    case 'completed': statusColor = 'border-blue-200 bg-blue-50'; statusText = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; statusIcon = '‚èπÔ∏è'; break;
                    case 'out-of-service': statusColor = 'border-red-200 bg-red-50'; statusText = '‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusIcon = '‚ùå'; break;
                }
                card.className = `p-2 sm:p-4 border rounded-lg text-center flex flex-col justify-between`;
                let cardHTML = `<div><div class="text-xl sm:text-2xl mb-2">${statusIcon}</div><div class="font-semibold text-sm sm:text-base text-gray-800">${vehicle}</div><div class="text-xs sm:text-sm text-gray-600">${statusText}</div>${status.lastMileage ? `<div class="text-xs text-gray-500 mt-1">‡πÑ‡∏°‡∏•‡πå: ${status.lastMileage}</div>` : ''}</div>`;
                
                if (currentUser && currentUser.role === 'supervisor') {
                    const isOutOfService = status.status === 'out-of-service';
                    const buttonText = isOutOfService ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢';
                    const buttonColor = isOutOfService ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    cardHTML += `<button onclick="window.toggleVehicleStatus('${vehicle}')" class="mt-2 text-xs font-semibold py-1 px-2 rounded-full ${buttonColor}">${buttonText}</button>`;
                }
                card.innerHTML = cardHTML;
                grid.appendChild(card);
            });
        }

        function updateChargerStatusGrid() {
            const grid = document.getElementById('chargerStatusGrid');
            grid.innerHTML = '';
            chargers.forEach(charger => {
                const status = chargerStatuses[charger] || { status: 'available', totalUsage: 0 };
                const card = document.createElement('div');
                let statusColor = '', statusText = '', statusIcon = '';
                switch(status.status) {
                    case 'available': statusColor = 'border-green-200 bg-green-50'; statusText = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusIcon = 'üîå'; break;
                    case 'in-use': statusColor = 'border-orange-200 bg-orange-50'; statusText = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusIcon = '‚ö°'; break;
                    case 'out-of-service': statusColor = 'border-red-200 bg-red-50'; statusText = '‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; statusIcon = '‚ùå'; break;
                }
                card.className = `p-2 sm:p-4 border rounded-lg text-center flex flex-col justify-between`;
                let cardHTML = `<div><div class="text-xl sm:text-2xl mb-2">${statusIcon}</div><div class="font-semibold text-sm sm:text-base text-gray-800">${charger}</div><div class="text-sm text-gray-600">${statusText}</div><div class="text-xs text-gray-500 mt-1">‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß: ${status.totalUsage} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div></div>`;

                if (currentUser && currentUser.role === 'supervisor') {
                    const isOutOfService = status.status === 'out-of-service';
                    const buttonText = isOutOfService ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡∏µ‡∏¢';
                    const buttonColor = isOutOfService ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    cardHTML += `<button onclick="window.toggleChargerStatus('${charger}')" class="mt-2 text-xs font-semibold py-1 px-2 rounded-full ${buttonColor}">${buttonText}</button>`;
                }
                card.innerHTML = cardHTML;
                grid.appendChild(card);
            });
        }

        window.toggleVehicleStatus = async (vehicle) => {
            const currentStatus = vehicleStatuses[vehicle]?.status;
            if (currentStatus === 'charging' || currentStatus === 'completed') {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡∏£‡∏ñ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à', 'warning');
                return;
            }
            const newStatus = currentStatus === 'out-of-service' ? 'available' : 'out-of-service';
            const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
            try {
                await updateDoc(stateDocRef, {
                    [`vehicleStatuses.${vehicle}.status`]: newStatus
                });
            } catch (error) {
                console.error("Error updating vehicle status:", error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
            }
        };

        window.toggleChargerStatus = async (charger) => {
            const currentStatus = chargerStatuses[charger]?.status;
             if (currentStatus === 'in-use') {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞', '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà', 'warning');
                return;
            }
            const newStatus = currentStatus === 'out-of-service' ? 'available' : 'out-of-service';
            const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
            try {
                await updateDoc(stateDocRef, {
                    [`chargerStatuses.${charger}.status`]: newStatus
                });
            } catch (error) {
                console.error("Error updating charger status:", error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏î‡πâ', 'error');
            }
        };


        function updateActiveChargingSessions(activeSessions) {
            const container = document.getElementById('activeChargingSessions');
            const activeSessionValues = Object.values(activeSessions);

            if (activeSessionValues.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</div>';
                return;
            }

            container.innerHTML = '';
            activeSessionValues.forEach(session => {
                const sessionCard = document.createElement('div');
                sessionCard.className = 'border rounded-lg p-4 sm:p-6';
                sessionCard.id = `session-${session.sessionId}`;
                
                let statusBadge = '', actionButtons = '';
                const isOwner = currentUser && currentUser.name === session.startedBy;
                const canInteract = currentUser.role === 'employee' && isOwner;
                
                if (session.status === 'charging') {
                    statusBadge = `<span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800"><span class="w-2 h-2 rounded-full bg-yellow-500 mr-2 charging-pulse"></span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</span>`;
                    const buttonClass = canInteract ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-400 cursor-not-allowed';
                    const buttonDisabled = canInteract ? '' : 'disabled';
                    const buttonTitle = canInteract ? '' : '‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ú‡∏π‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ';
                    actionButtons = `<div class="mt-4 space-y-3"><div><label class="block text-sm font-semibold text-gray-700 mb-2">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à (%)</label><input type="number" id="kwhAfter-${session.sessionId}" step="1" min="0" max="100" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 80"></div><button onclick="window.finishAndSaveCharging('${session.sessionId}')" class="w-full text-white font-semibold py-2 px-4 rounded-lg transition duration-200 ${buttonClass}" ${buttonDisabled} title="${buttonTitle}">‚èπÔ∏è ‡∏à‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à</button></div>`;
                }

                sessionCard.innerHTML = `<div class="flex justify-between items-start mb-4"><div><h3 class="text-lg font-semibold text-gray-800">${session.licensePlate}</h3><p class="text-sm text-gray-600">‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${session.startTime}</p><p class="text-sm text-green-600">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à: ${session.chargerName}</p><p class="text-sm text-gray-500 font-medium">‡∏ú‡∏π‡πâ‡πÄ‡∏£‡∏¥‡πà‡∏°: ${session.startedBy || '-'}</p></div>${statusBadge}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm"><div><span class="text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</span><div class="font-semibold">${session.date}</div></div><div><span class="text-gray-600">‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå:</span><div class="font-semibold">${session.previousMileage} ‚Üí ${session.currentMileage}</div></div><div><span class="text-gray-600">% ‡∏Å‡πà‡∏≠‡∏ô:</span><div class="font-semibold">${session.kwhBefore}%</div></div><div><span class="text-gray-600">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤:</span><div class="font-semibold">${session.duration || '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à'}</div></div></div>${session.status === 'completed' ? `<div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm mt-3 pt-3 border-t"><div><span class="text-gray-600">% ‡∏´‡∏•‡∏±‡∏á:</span><div class="font-semibold">${session.kwhAfter}%</div></div><div><span class="text-gray-600">‡∏´‡∏ô‡πà‡∏ß‡∏¢:</span><div class="font-semibold">${session.units}</div></div><div><span class="text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢:</span><div class="font-semibold">‡∏ø${session.pricePerUnit}</div></div><div><span class="text-gray-600">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü:</span><div class="font-semibold text-green-600">‡∏ø${session.electricityCost}</div></div></div>` : ''}${actionButtons}`;
                container.appendChild(sessionCard);
            });
        }
        
        document.getElementById('startNewChargingBtn').addEventListener('click', async function() {
            const date = document.getElementById('date').value;
            const licensePlate = document.getElementById('licensePlate').value;
            const chargerName = document.getElementById('chargerName').value;
            const previousMileage = document.getElementById('previousMileage').value;
            const currentMileage = document.getElementById('currentMileage').value;
            const kwhBefore = document.getElementById('kwhBefore').value;

            if (!date || !licensePlate || !chargerName || !currentMileage || !kwhBefore) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning'); return;
            }
            if (vehicleStatuses[licensePlate]?.status !== 'available') {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏î‡πâ', `‡∏£‡∏ñ ${licensePlate} ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`, 'error'); return;
            }
             if (chargerStatuses[chargerName]?.status !== 'available') {
                Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏î‡πâ', `‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à ${chargerName} ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô`, 'error'); return;
            }
            if (previousMileage && parseFloat(currentMileage) <= parseFloat(previousMileage)) {
                Swal.fire('‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡∏Ç‡πÑ‡∏°‡∏•‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô', 'warning'); return;
            }

            const sessionId = `${licensePlate}-${Date.now()}`;
            const now = new Date();
            const startTime = now.toTimeString().slice(0, 5);
            
            const newSession = {
                date, licensePlate, chargerName, startTime,
                previousMileage: previousMileage || '0',
                currentMileage, kwhBefore,
                status: 'charging',
                startedBy: currentUser.name,
                startedAt: now.toISOString()
            };
            
            const batch = writeBatch(db);
            const activeSessionRef = doc(db, `artifacts/${appId}/active_sessions`, sessionId);
            batch.set(activeSessionRef, newSession);
            
            const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
            batch.update(stateDocRef, {
                [`vehicleStatuses.${licensePlate}.status`]: 'charging',
                [`vehicleStatuses.${licensePlate}.sessionId`]: sessionId,
                [`chargerStatuses.${chargerName}.status`]: 'in-use',
                [`chargerStatuses.${chargerName}.sessionId`]: sessionId
            });

            try {
                await batch.commit();
                resetNewChargingForm();
                Swal.fire('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÅ‡∏•‡πâ‡∏ß!', `‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏ñ ${licensePlate}`, 'success');
            } catch (error) {
                console.error("Error starting charging session:", error);
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏î‡πâ', 'error');
            }
        });

        window.finishAndSaveCharging = async function(sessionId) {
            const kwhAfterInput = document.getElementById(`kwhAfter-${sessionId}`);
            const kwhAfter = kwhAfterInput.value;

            const activeSessionRef = doc(db, `artifacts/${appId}/active_sessions`, sessionId);
            const sessionDoc = await getDoc(activeSessionRef);
            if (!sessionDoc.exists()) { Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ô‡∏µ‡πâ', 'error'); return; }
            const session = sessionDoc.data();

            if (!kwhAfter || parseFloat(kwhAfter) <= parseFloat(session.kwhBefore)) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'warning'); return;
            }

            const result = await Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
                text: "‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#10B981',
                cancelButtonColor: '#6B7280',
                confirmButtonText: '‡πÉ‡∏ä‡πà, ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏•‡∏¢!',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
            });

            if (result.isConfirmed) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', html: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                const now = new Date();
                const endTime = now.toTimeString().slice(0, 5);
            
                const kwhDifference = parseFloat(kwhAfter) - parseFloat(session.kwhBefore);
                const durationInMinutes = kwhDifference * 1.45;
                const units = (durationInMinutes * 16) / 60;
                
                const [startHours, startMinutes] = session.startTime.split(':').map(Number);
                const timeInMinutes = startHours * 60 + startMinutes;
                let pricePerUnit = 3.5;
                if ((timeInMinutes >= 720 && timeInMinutes < 780) || (timeInMinutes >= 1020 && timeInMinutes < 1050)) {
                    pricePerUnit = 4.1839;
                } else if ((timeInMinutes >= 0 && timeInMinutes < 60) || (timeInMinutes >= 300 && timeInMinutes < 330)) {
                    pricePerUnit = 2.6037;
                }
                const electricityCost = units * pricePerUnit;

                const historyData = { 
                    ...session,
                    endTime, 
                    duration: `${Math.round(durationInMinutes)}`,
                    kwhAfter: kwhAfter,
                    pricePerUnit: pricePerUnit.toFixed(4), 
                    units: units.toFixed(2), 
                    electricityCost: electricityCost.toFixed(2),
                    status: 'saved', 
                    recordedBy: currentUser.name, 
                    recordedAt: now.toISOString()
                };

                const batch = writeBatch(db);
                const historyDocRef = doc(collection(db, `artifacts/${appId}/history`));
                batch.set(historyDocRef, historyData);
                batch.delete(activeSessionRef);

                const stateDocRef = doc(db, `artifacts/${appId}/state/main`);
                batch.update(stateDocRef, {
                    [`vehicleStatuses.${session.licensePlate}.status`]: 'available',
                    [`vehicleStatuses.${session.licensePlate}.sessionId`]: null,
                    [`vehicleStatuses.${session.licensePlate}.lastMileage`]: session.currentMileage,
                    [`chargerStatuses.${session.chargerName}.status`]: 'available',
                    [`chargerStatuses.${session.chargerName}.sessionId`]: null,
                    [`chargerStatuses.${session.chargerName}.totalUsage`]: (chargerStatuses[session.chargerName]?.totalUsage || 0) + 1
                });

                try {
                    await batch.commit();
                    
                    if (vehicleStatuses[session.licensePlate]) {
                        vehicleStatuses[session.licensePlate].lastMileage = session.currentMileage;
                    }

                    Swal.fire('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ñ ${session.licensePlate} ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    
                    resetNewChargingForm();

                } catch (error) {
                    console.error("Error saving data:", error);
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                }
            }
        }

        window.selectLicensePlate = async function(plate) {
            document.querySelectorAll('.license-btn').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600'));
            document.getElementById(`btn-${plate}`).classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            document.getElementById('licensePlate').value = plate;
            
            const previousMileage = vehicleStatuses[plate]?.lastMileage || 0;
            const previousMileageField = document.getElementById('previousMileage');
            if (previousMileage > 0) {
                 previousMileageField.value = previousMileage;
            } else {
                 previousMileageField.value = '';
                 previousMileageField.placeholder = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤';
            }
        }
        
        window.selectCharger = function(charger) {
            document.querySelectorAll('.charger-btn').forEach(btn => btn.classList.remove('bg-green-600', 'text-white', 'border-green-600'));
            document.getElementById(`btn-charger-${charger}`).classList.add('bg-green-600', 'text-white', 'border-green-600');
            document.getElementById('chargerName').value = charger;
        }

        function createLicensePlateButtons() {
            const container = document.getElementById('licensePlateButtons');
            container.innerHTML = '';
            vehicles.forEach(vehicle => {
                const button = document.createElement('button');
                button.type = 'button';
                button.id = `btn-${vehicle}`;
                button.className = 'license-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-blue-500 transition duration-200 font-semibold';
                button.textContent = vehicle;
                button.onclick = () => window.selectLicensePlate(vehicle);
                container.appendChild(button);
            });
        }

        function createChargerButtons() {
            const container = document.getElementById('chargerButtons');
            container.innerHTML = '';
            chargers.forEach(charger => {
                const button = document.createElement('button');
                button.type = 'button';
                button.id = `btn-charger-${charger}`;
                button.className = 'charger-btn px-4 py-3 border-2 border-gray-300 rounded-lg hover:border-green-500 transition duration-200 font-semibold';
                button.textContent = charger;
                button.onclick = () => window.selectCharger(charger);
                container.appendChild(button);
            });
        }
        
        function setTodayDate() { document.getElementById('date').valueAsDate = new Date(); }
        
        window.toggleNewChargingForm = function() {
            const container = document.getElementById('newChargingFormContainer');
            const toggleText = document.getElementById('toggleFormText');
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggleText.textContent = '‡∏ã‡πà‡∏≠‡∏ô';
            } else {
                container.style.display = 'none';
                toggleText.textContent = '‡πÅ‡∏™‡∏î‡∏á';
            }
        }

        function resetNewChargingForm() {
            document.getElementById('newChargingForm').reset();
            setTodayDate();
            if (currentUser.role === 'employee') {
                prepopulateForm(currentUser.vehicle, currentUser.charger);
            }
        }

        function updatePricePerUnitDisplay() {
            const now = new Date();
            const timeInMinutes = now.getHours() * 60 + now.getMinutes();
            let pricePerUnit = 3.5, timeType = '‡∏ä‡πà‡∏ß‡∏á‡∏õ‡∏Å‡∏ï‡∏¥', color = 'text-yellow-600 bg-yellow-50';
            if ((timeInMinutes >= 720 && timeInMinutes < 780) || (timeInMinutes >= 1020 && timeInMinutes < 1050)) {
                pricePerUnit = 4.1839; timeType = '‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏µ‡∏Ñ'; color = 'text-red-600 bg-red-50';
            } else if ((timeInMinutes >= 0 && timeInMinutes < 60) || (timeInMinutes >= 300 && timeInMinutes < 330)) {
                pricePerUnit = 2.6037; timeType = '‡∏ä‡πà‡∏ß‡∏á‡∏≠‡∏≠‡∏ü‡∏û‡∏µ‡∏Ñ'; color = 'text-green-600 bg-green-50';
            }
            const display = document.getElementById('pricePerUnitDisplay');
            if (display) {
                display.className = `w-full px-4 py-3 border border-gray-300 rounded-lg font-medium ${color}`;
                display.textContent = `${pricePerUnit.toFixed(4)} ‡∏ö‡∏≤‡∏ó (${timeType})`;
            }
        }
        
        window.showSection = function(section) {
            document.getElementById('chargingSection').classList.add('hidden');
            document.getElementById('summarySection').classList.add('hidden');
            document.getElementById('btn-charging').className = 'px-6 py-2 rounded-lg font-medium transition duration-200 text-gray-600 hover:bg-gray-100';
            document.getElementById('btn-summary').className = 'px-6 py-2 rounded-lg font-medium transition duration-200 text-gray-600 hover:bg-gray-100';
            if (section === 'charging') {
                document.getElementById('chargingSection').classList.remove('hidden');
                document.getElementById('btn-charging').className = 'px-6 py-2 rounded-lg font-medium transition duration-200 bg-blue-600 text-white';
            } else if (section === 'summary') {
                document.getElementById('summarySection').classList.remove('hidden');
                document.getElementById('btn-summary').className = 'px-6 py-2 rounded-lg font-medium transition duration-200 bg-blue-600 text-white';
                loadSummaryData();
            }
        }
        
        function initializeHistoryFilters() {
            const vehicleFilter = document.getElementById('historyVehicleFilter');
            vehicleFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>';
            vehicles.forEach(v => vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`);
            
            const monthFilter = document.getElementById('historyMonthFilter');
            monthFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>';
            const currentDate = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthValue = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthText = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
                monthFilter.innerHTML += `<option value="${monthValue}">${monthText}</option>`;
            }
        }
        
        function displayChargingHistory(records) {
            const container = document.getElementById('chargingHistoryContainer');
            const vehicleFilter = document.getElementById('historyVehicleFilter').value;
            const monthFilter = document.getElementById('historyMonthFilter').value;

            let filteredRecords = records;
            if (vehicleFilter) filteredRecords = filteredRecords.filter(r => r.licensePlate === vehicleFilter);
            if (monthFilter) filteredRecords = filteredRecords.filter(r => r.date.startsWith(monthFilter));

            if (filteredRecords.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>`;
                return;
            }
            const groupedData = groupRecordsByVehicleMonthWeek(filteredRecords);
            container.innerHTML = '<div class="overflow-x-auto"></div>';
            buildHistoryDOM(groupedData, container.firstElementChild);
        }

        function buildHistoryDOM(groupedData, container) {
            Object.keys(groupedData).sort().forEach(vehicle => {
                const vehicleData = groupedData[vehicle];
                const vehicleSection = document.createElement('div');
                vehicleSection.className = 'mb-8';
                vehicleSection.innerHTML = `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4"><h3 class="text-lg font-bold text-blue-800">üöó ‡∏£‡∏ñ ${vehicle}</h3></div>`;
                
                Object.keys(vehicleData).sort().reverse().forEach(month => {
                    const monthData = vehicleData[month];
                    const monthTotals = calculateTotals(Object.values(monthData).flat());
                    const monthSection = document.createElement('div');
                    monthSection.className = 'mb-6';
                    monthSection.innerHTML = `<div class="bg-gray-50 border border-gray-200 rounded-t-lg p-4"><div class="flex justify-between items-center"><h4 class="text-md font-semibold text-gray-800">üìÖ ${formatMonthToThai(month)}</h4><div class="text-sm text-gray-600"><span class="mr-4">‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${monthTotals.count}</span><span class="mr-4">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${monthTotals.units.toFixed(2)}</span><span class="text-green-600 font-semibold">‡∏ø${monthTotals.cost.toFixed(2)}</span></div></div></div>`;
                    
                    const weeksContainer = document.createElement('div');
                    weeksContainer.className = 'border-l border-r border-b border-gray-200 rounded-b-lg';
                    Object.keys(monthData).sort().forEach((week, index) => {
                        const weekRecords = monthData[week];
                        const weekTotals = calculateTotals(weekRecords);
                        const weekId = `week-${vehicle}-${month}-${week.replace(/ /g, '-')}`;
                        const weekSection = document.createElement('div');
                        weekSection.className = index > 0 ? 'border-t border-gray-100' : '';
                        weekSection.innerHTML = `<div class="bg-white p-3 cursor-pointer hover:bg-gray-50" onclick="window.toggleWeekDetails('${weekId}')"><div class="flex justify-between items-center"><div class="flex items-center"><span class="text-sm font-medium text-gray-700">üìä ${week}</span><span id="toggle-icon-${weekId}" class="ml-2 text-gray-400">‚ñº</span></div><div class="text-sm text-gray-600"><span class="mr-3">‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ${weekTotals.count}</span><span class="mr-3">‡∏´‡∏ô‡πà‡∏ß‡∏¢: ${weekTotals.units.toFixed(2)}</span><span class="text-green-600 font-medium">‡∏ø${weekTotals.cost.toFixed(2)}</span></div></div></div><div id="${weekId}" class="hidden bg-gray-50 p-4 overflow-x-auto"><table class="w-full text-sm whitespace-nowrap"><thead><tr class="text-gray-600"><th class="text-left py-2 px-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th class="text-left py-2 px-2">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à</th><th class="text-left py-2 px-2">‡πÄ‡∏ß‡∏•‡∏≤</th><th class="text-left py-2 px-2">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th><th class="text-left py-2 px-2">% ‡∏Å‡πà‡∏≠‡∏ô</th><th class="text-left py-2 px-2">% ‡∏´‡∏•‡∏±‡∏á</th><th class="text-left py-2 px-2">‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="text-left py-2 px-2">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th><th class="text-left py-2 px-2">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü</th><th class="text-left py-2 px-2">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th></tr></thead><tbody>${weekRecords.map(record => `
                            <tr class="border-t border-gray-200"><td class="py-2 px-2">${formatDateToThai(record.date)}</td><td class="py-2 px-2 text-green-600">${record.chargerName || '-'}</td><td class="py-2 px-2">${formatTimeToShort(record.startTime || '-')}${record.endTime ? ' - ' + formatTimeToShort(record.endTime) : ''}</td><td class="py-2 px-2">${record.duration || '-'} ‡∏ô‡∏≤‡∏ó‡∏µ</td><td class="py-2 px-2 text-gray-600">${record.kwhBefore}%</td><td class="py-2 px-2 text-gray-600">${record.kwhAfter || '-'}%</td><td class="py-2 px-2">${record.units || '-'}</td><td class="py-2 px-2 text-blue-600">‡∏ø${parseFloat(record.pricePerUnit || 0).toFixed(4)}</td><td class="py-2 px-2 text-green-600">‡∏ø${parseFloat(record.electricityCost || 0).toFixed(2)}</td><td class="py-2 px-2 font-medium">${record.recordedBy || '-'}</td></tr>`).join('')}</tbody></table></div>`;
                        weeksContainer.appendChild(weekSection);
                    });
                    monthSection.appendChild(weeksContainer);
                    vehicleSection.appendChild(monthSection);
                });
                container.appendChild(vehicleSection);
            });
        }
        
        window.toggleWeekDetails = function(weekId) {
            const details = document.getElementById(weekId);
            const icon = document.getElementById(`toggle-icon-${weekId}`);
            details.classList.toggle('hidden');
            icon.textContent = details.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
        }

        function initializeSummaryFilters() {
            const vehicleFilter = document.getElementById('summaryVehicleFilter');
            vehicleFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏±‡∏ô</option>';
            vehicles.forEach(v => vehicleFilter.innerHTML += `<option value="${v}">${v}</option>`);
            
            const monthFilter = document.getElementById('summaryMonthFilter');
            monthFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>';
            const currentDate = new Date();
            for (let i = 0; i < 12; i++) {
                const date = new Date(currentDate.getFullYear(), currentDate.getMonth() - i, 1);
                const monthValue = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const monthText = date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
                monthFilter.innerHTML += `<option value="${monthValue}">${monthText}</option>`;
            }
        }
        
        function loadSummaryData() {
            const vehicleFilter = document.getElementById('summaryVehicleFilter').value;
            const monthFilter = document.getElementById('summaryMonthFilter').value;

            let filteredRecords = allHistoryRecords;
            if (vehicleFilter) filteredRecords = filteredRecords.filter(r => r.licensePlate === vehicleFilter);
            if (monthFilter) filteredRecords = filteredRecords.filter(r => r.date.startsWith(monthFilter));
            
            if (filteredRecords.length > 0) {
                const summaryData = calculateSummaryStatistics(filteredRecords);
                updateSummaryCards(summaryData);
                updateSummaryCharts(summaryData);
                updateVehicleStatsTable(summaryData.vehicleStats);
                updateChargerStatsTable(summaryData.chargerStats);
            } else {
                updateSummaryCards({ totalSessions: 0, totalCost: 0, totalUnits: 0, totalMinutes: 0 });
                Object.values(summaryCharts).forEach(chart => chart && chart.destroy());
                document.getElementById('vehicleStatsContainer').innerHTML = '<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                document.getElementById('chargerStatsContainer').innerHTML = '<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
            }
        }

        function calculateSummaryStatistics(records) {
            let totalSessions = 0, totalCost = 0, totalUnits = 0, totalMinutes = 0;
            const vehicleStats = {}, monthlyData = {}, chargerStats = {};
            
            // Initialize stats for all vehicles and chargers to ensure they appear in the summary
            vehicles.forEach(v => { vehicleStats[v] = { sessions: 0, cost: 0, units: 0, minutes: 0 }; });
            chargers.forEach(c => { chargerStats[c] = { sessions: 0, cost: 0, units: 0, minutes: 0 }; });

            records.forEach(record => {
                totalSessions++;
                const cost = parseFloat(record.electricityCost) || 0;
                const units = parseFloat(record.units) || 0;
                const duration = parseInt(record.duration) || 0;
                totalCost += cost;
                totalUnits += units;
                totalMinutes += duration;
                
                const vehicle = record.licensePlate;
                if (vehicle && vehicleStats[vehicle]) {
                    vehicleStats[vehicle].sessions++;
                    vehicleStats[vehicle].cost += cost;
                    vehicleStats[vehicle].units += units;
                    vehicleStats[vehicle].minutes += duration;
                }

                const charger = record.chargerName;
                if(charger && chargerStats[charger]) {
                    chargerStats[charger].sessions++;
                    chargerStats[charger].cost += cost;
                    chargerStats[charger].units += units;
                    chargerStats[charger].minutes += duration;
                }
                
                const monthKey = record.date.substring(0, 7);
                if (!monthlyData[monthKey]) monthlyData[monthKey] = { sessions: 0, cost: 0, units: 0 };
                monthlyData[monthKey].sessions++;
                monthlyData[monthKey].cost += cost;
                monthlyData[monthKey].units += units;
            });
            return { totalSessions, totalCost, totalUnits, totalMinutes, vehicleStats, monthlyData, chargerStats };
        }
        function updateSummaryCards(data) {
            document.getElementById('totalSessions').textContent = data.totalSessions.toLocaleString();
            document.getElementById('totalCost').textContent = `‡∏ø${data.totalCost.toFixed(2)}`;
            document.getElementById('totalUnits').textContent = data.totalUnits.toFixed(2);
            const hours = Math.floor(data.totalMinutes / 60);
            const minutes = data.totalMinutes % 60;
            document.getElementById('totalTime').textContent = hours > 0 ? `${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ` : `${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ`;
        }
        function updateSummaryCharts(data) { 
            Object.values(summaryCharts).forEach(chart => chart && chart.destroy());
            const vehicleNames = Object.keys(data.vehicleStats).sort((a, b) => parseInt(a.split('-')[1]) - parseInt(b.split('-')[1]));
            
            const costCtx = document.getElementById('costChart').getContext('2d');
            summaryCharts.costChart = new Chart(costCtx, {
                type: 'bar',
                data: {
                    labels: vehicleNames,
                    datasets: [{
                        label: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü',
                        data: vehicleNames.map(v => data.vehicleStats[v].cost),
                        backgroundColor: '#10B981'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü: ‡∏ø' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡∏ø' + value.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });

            const sessionsCtx = document.getElementById('sessionsChart').getContext('2d');
            summaryCharts.sessionsChart = new Chart(sessionsCtx, { type: 'bar', data: { labels: vehicleNames, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á', data: vehicleNames.map(v => data.vehicleStats[v].sessions), backgroundColor: '#3B82F6' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });
            
            const chargerNames = Object.keys(data.chargerStats).sort();
            const chargerUsageCtx = document.getElementById('chargerUsageChart').getContext('2d');
            summaryCharts.chargerUsageChart = new Chart(chargerUsageCtx, { type: 'bar', data: { labels: chargerNames, datasets: [{ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á', data: chargerNames.map(c => data.chargerStats[c].sessions), backgroundColor: '#F59E0B' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } } } });


            const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            const sortedMonths = Object.keys(data.monthlyData).sort();
            const monthLabels = sortedMonths.map(m => formatMonthToThai(m));
            summaryCharts.monthlyTrendChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: '‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü (‡∏ö‡∏≤‡∏ó)',
                        data: sortedMonths.map(m => data.monthlyData[m].cost),
                        borderColor: '#10B981',
                        yAxisID: 'y'
                    }, {
                        label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á',
                        data: sortedMonths.map(m => data.monthlyData[m].sessions),
                        borderColor: '#3B82F6',
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                callback: function(value) {
                                    return '‡∏ø' + value.toFixed(2);
                                }
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        function updateVehicleStatsTable(vehicleStats) { 
            const container = document.getElementById('vehicleStatsContainer');
            container.innerHTML = '';
            if (Object.keys(vehicleStats).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            const sortedVehicles = Object.keys(vehicleStats).sort();
            sortedVehicles.forEach((vehicle, index) => {
                const stats = vehicleStats[vehicle];
                const avgPerSession = stats.sessions > 0 ? stats.cost / stats.sessions : 0;
                const hours = Math.floor(stats.minutes / 60);
                const minutes = stats.minutes % 60;
                const vehicleSection = document.createElement('div');
                vehicleSection.className = `border border-gray-200 rounded-lg ${index > 0 ? 'mt-4' : ''}`;
                vehicleSection.innerHTML = `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')"><div class="flex justify-between items-center"><h4 class="text-lg font-bold text-blue-800">üöó ‡∏£‡∏ñ ${vehicle}</h4><div class="text-sm text-blue-600"><span class="mr-4">‡∏£‡∏ß‡∏° ${stats.sessions} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span><span class="font-semibold text-green-600">‡∏ø${stats.cost.toFixed(2)}</span></div></div></div><div class="hidden bg-gray-50 p-4 border-t border-gray-200"><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-sm"><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div class="font-bold text-xl text-blue-600">${stats.sessions}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-purple-600">${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-orange-600">${stats.units.toFixed(1)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-green-600">‡∏ø${stats.cost.toFixed(0)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div class="font-bold text-xl text-indigo-600">‡∏ø${avgPerSession.toFixed(0)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><div class="font-bold text-xl text-pink-600">‡∏ø${stats.units > 0 ? (stats.cost / stats.units).toFixed(2) : '0'}</div></div></div></div>`;
                container.appendChild(vehicleSection);
            });
        }
        function updateChargerStatsTable(chargerStats) { 
            const container = document.getElementById('chargerStatsContainer');
            container.innerHTML = '';
            if (Object.keys(chargerStats).length === 0) {
                container.innerHTML = '<div class="text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>';
                return;
            }
            const sortedChargers = Object.keys(chargerStats).sort();
            sortedChargers.forEach((charger, index) => {
                const stats = chargerStats[charger];
                const avgPerSession = stats.sessions > 0 ? stats.cost / stats.sessions : 0;
                const hours = Math.floor(stats.minutes / 60);
                const minutes = stats.minutes % 60;
                const chargerSection = document.createElement('div');
                chargerSection.className = `border border-gray-200 rounded-lg ${index > 0 ? 'mt-4' : ''}`;
                chargerSection.innerHTML = `<div class="bg-green-50 border-l-4 border-green-500 p-4 cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')"><div class="flex justify-between items-center"><h4 class="text-lg font-bold text-green-800">üîå ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à ${charger}</h4><div class="text-sm text-green-600"><span class="mr-4">‡∏£‡∏ß‡∏° ${stats.sessions} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span><span class="font-semibold text-green-800">‡∏ø${stats.cost.toFixed(2)}</span></div></div></div><div class="hidden bg-gray-50 p-4 border-t border-gray-200"><div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-sm"><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div class="font-bold text-xl text-blue-600">${stats.sessions}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-purple-600">${hours} ‡∏ä‡∏°. ${minutes} ‡∏ô‡∏≤‡∏ó‡∏µ</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-orange-600">${stats.units.toFixed(1)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü‡∏£‡∏ß‡∏°</div><div class="font-bold text-xl text-green-600">‡∏ø${stats.cost.toFixed(0)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢/‡∏Ñ‡∏£‡∏±‡πâ‡∏á</div><div class="font-bold text-xl text-indigo-600">‡∏ø${avgPerSession.toFixed(0)}</div></div><div class="text-center bg-white rounded-lg p-3 shadow-sm"><div class="text-gray-600 text-xs mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</div><div class="font-bold text-xl text-pink-600">‡∏ø${stats.units > 0 ? (stats.cost / stats.units).toFixed(2) : '0'}</div></div></div></div>`;
                container.appendChild(chargerSection);
            });
        }
        function groupRecordsByVehicleMonthWeek(records) { 
            const grouped = {};
            records.forEach(record => {
                const vehicle = record.licensePlate;
                const date = new Date(record.date);
                const month = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                const weekOfMonth = Math.ceil((date.getDate() + new Date(date.getFullYear(), date.getMonth(), 1).getDay()) / 7);
                const week = `‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà ${weekOfMonth}`;
                if (!grouped[vehicle]) grouped[vehicle] = {};
                if (!grouped[vehicle][month]) grouped[vehicle][month] = {};
                if (!grouped[vehicle][month][week]) grouped[vehicle][month][week] = [];
                grouped[vehicle][month][week].push(record);
            });
            return grouped;
        }
        function calculateTotals(records) { 
            return records.reduce((acc, r) => ({ count: acc.count + 1, units: acc.units + (parseFloat(r.units) || 0), cost: acc.cost + (parseFloat(r.electricityCost) || 0) }), { count: 0, units: 0, cost: 0 });
        }
        function formatMonthToThai(monthString) { 
            const [year, month] = monthString.split('-');
            return new Date(year, month - 1).toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });
        }
        function formatDateToThai(dateString) { 
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        function formatTimeToShort(timeString) { 
            return timeString ? timeString.slice(0, 5) : '-';
        }
    </script>
</body>
</html>

